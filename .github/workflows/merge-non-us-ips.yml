name: ğŸš€ åˆå¹¶å’Œå»é‡éç¾å›½IP

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 17:00 (åŒ—äº¬æ—¶é—´ 01:00) æ‰§è¡Œ
    - cron: '0 17 * * *'
  
  workflow_dispatch:
    name: æ‰‹åŠ¨è§¦å‘åˆå¹¶
    inputs:
      date_override:
        description: 'ğŸ“… æŒ‡å®šå¤„ç†æ—¥æœŸ (YYYY-MM-DD)'
        required: false
        default: ''
        type: string

env:
  TIMEZONE: 'Asia/Shanghai'

permissions:
  contents: write

jobs:
  merge-and-deduplicate:
    name: ğŸ”„ åˆå¹¶å’Œå»é‡IPæ–‡ä»¶
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      # æ­¥éª¤ 2: æ˜¾ç¤ºç›®å½•ç»“æ„
      - name: ğŸ“ æ˜¾ç¤ºä»£ç åº“ç»“æ„
        run: |
          echo "=== ğŸ“‚ ä»£ç åº“ç»“æ„ ==="
          find . -name "non_us_ips_*.txt" | head -10 | while read file; do
            echo "  ğŸ“„ $file"
          done
          
          echo ""
          echo "=== ğŸ“ non_us_ips ç›®å½•å†…å®¹ ==="
          if [ -d "non_us_ips" ]; then
            ls -la non_us_ips/ | head -10
          else
            echo "  âŒ non_us_ips ç›®å½•ä¸å­˜åœ¨"
          fi
          
      # æ­¥éª¤ 3: è®¡ç®—ç›®æ ‡æ—¥æœŸ
      - name: ğŸ—“ï¸ è®¡ç®—ç›®æ ‡æ—¥æœŸ
        id: date_calc
        run: |
          export TZ='${{ env.TIMEZONE }}'
          
          echo "=== ğŸ“… æ—¥æœŸè®¡ç®— ==="
          if [ -n "${{ github.event.inputs.date_override }}" ]; then
            TARGET_DATE="${{ github.event.inputs.date_override }}"
            echo "ğŸ¯ ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šæ—¥æœŸ: $TARGET_DATE"
          else
            TARGET_DATE=$(date -d "1 days ago" +%Y%m%d)
            echo "ğŸ”„ ä½¿ç”¨è‡ªåŠ¨è®¡ç®—çš„æ˜¨å¤©æ—¥æœŸ: $TARGET_DATE"
          fi
          
          # éªŒè¯æ—¥æœŸæ ¼å¼
          if [[ $TARGET_DATE =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
            TARGET_DATE_CLEAN=$(echo $TARGET_DATE | tr -d '-')
            echo "ğŸ§¹ æ¸…ç†åæ—¥æœŸæ ¼å¼: $TARGET_DATE_CLEAN"
          else
            TARGET_DATE_CLEAN=$TARGET_DATE
          fi
          
          echo "target_date=$TARGET_DATE_CLEAN" >> $GITHUB_OUTPUT
          echo "ğŸ¯ æœ€ç»ˆå¤„ç†æ—¥æœŸ: $TARGET_DATE_CLEAN"
          
      # æ­¥éª¤ 4: æ‰§è¡Œåˆå¹¶è„šæœ¬
      - name: ğŸ”§ æ‰§è¡Œåˆå¹¶å’Œå»é‡
        run: |
          TARGET_DATE="${{ steps.date_calc.outputs.target_date }}"
          
          echo "=== ğŸš€ å¼€å§‹æ‰§è¡Œåˆå¹¶è„šæœ¬ ==="
          echo "ğŸ“… å¤„ç†æ—¥æœŸ: $TARGET_DATE"
          echo "ğŸ æ‰§è¡Œè„šæœ¬: .github/scripts/merge_non_us_ips.py"
          
          # æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ ! -f ".github/scripts/merge_non_us_ips.py" ]; then
            echo "âŒ é”™è¯¯: åˆå¹¶è„šæœ¬ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ‰§è¡ŒPythonè„šæœ¬
          python .github/scripts/merge_non_us_ips.py "$TARGET_DATE"
          
          echo "âœ… åˆå¹¶è„šæœ¬æ‰§è¡Œå®Œæˆ"
          
      # æ­¥éª¤ 5: æ¸…ç†æ—§æ–‡ä»¶
      - name: ğŸ§¹ æ¸…ç†è¿‡æœŸæ–‡ä»¶
        run: |
          echo "=== ğŸ—‘ï¸ å¼€å§‹æ¸…ç†è¿‡æœŸæ–‡ä»¶ ==="
          
          # æ£€æŸ¥æ¸…ç†è„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ ! -f ".github/scripts/cleanup_old_files.py" ]; then
            echo "âŒ é”™è¯¯: æ¸…ç†è„šæœ¬ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ‰§è¡Œæ¸…ç†è„šæœ¬
          python .github/scripts/cleanup_old_files.py
          
          echo "âœ… æ–‡ä»¶æ¸…ç†å®Œæˆ"
          
      # æ­¥éª¤ 6: æäº¤æ›´æ”¹
      - name: ğŸ“ æäº¤å’Œæ¨é€æ›´æ”¹
        run: |
          echo "=== ğŸ“¤ å¼€å§‹æäº¤æ›´æ”¹ ==="
          
          # é…ç½®Gitç”¨æˆ·
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # æ˜¾ç¤ºæ›´æ”¹çŠ¶æ€
          echo "ğŸ“Š æ›´æ”¹çŠ¶æ€:"
          git status --short
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          git add -A
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --cached --quiet; then
            echo "ğŸŸ¡ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          else
            echo "ğŸŸ¢ æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤"
            
            # è·å–è¯¦ç»†çš„æ–‡ä»¶å˜æ›´ç»Ÿè®¡
            DELETED_FILES=$(git diff --cached --name-status | grep "^D" | wc -l)
            ADDED_FILES=$(git diff --cached --name-status | grep "^A" | wc -l)
            MODIFIED_FILES=$(git diff --cached --name-status | grep "^M" | wc -l)
            
            echo "ğŸ“ˆ å˜æ›´ç»Ÿè®¡:"
            echo "  â• æ–°å¢æ–‡ä»¶: $ADDED_FILES"
            echo "  âœï¸ ä¿®æ”¹æ–‡ä»¶: $MODIFIED_FILES"
            echo "  ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶: $DELETED_FILES"
            
            # ç”Ÿæˆæäº¤ä¿¡æ¯
            COMMIT_MSG="ğŸ¤– è‡ªåŠ¨æ›´æ–°: åˆå¹¶å’Œå»é‡éç¾å›½IPåœ°å€ ${{ steps.date_calc.outputs.target_date }}"
            COMMIT_MSG+=" [æ–°å¢:$ADDED_FILES ä¿®æ”¹:$MODIFIED_FILES åˆ é™¤:$DELETED_FILES]"
            COMMIT_MSG+=" - $(date +'%Y-%m-%d %H:%M:%S')"
            
            # æäº¤å¹¶æ¨é€
            git commit -m "$COMMIT_MSG"
            git push
            
            echo "âœ… æ›´æ”¹å·²æäº¤å¹¶æ¨é€"
            echo "ğŸ“‹ æäº¤ä¿¡æ¯: $COMMIT_MSG"
          fi
          
      # æ­¥éª¤ 7: å®Œæˆé€šçŸ¥
      - name: âœ… å·¥ä½œæµå®Œæˆ
        if: always()
        run: |
          echo ""
          echo "=== ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆ ==="
          echo "ğŸ•’ å®Œæˆæ—¶é—´: $(date)"
          echo "ğŸ“… å¤„ç†æ—¥æœŸ: ${{ steps.date_calc.outputs.target_date }}"
          echo "ğŸ”— å·¥ä½œæµ: ${{ github.workflow }}"
          echo "ğŸƒ è¿è¡ŒID: ${{ github.run_id }}"
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… çŠ¶æ€: æˆåŠŸå®Œæˆ"
          else
            echo "âŒ çŠ¶æ€: æ‰§è¡Œå¤±è´¥"
          fi
