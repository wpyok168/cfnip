name: Merge Non-US IPs

on:
  schedule:
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      date_override:
        description: '指定日期 (YYYY-MM-DD)，默认为前天'
        required: false
        default: ''
        type: string

jobs:
  merge-files:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          
      - name: Calculate target date
        id: date_calc
        run: |
          export TZ='Asia/Shanghai'
          if [ -n "${{ github.event.inputs.date_override }}" ]; then
            TARGET_DATE="${{ github.event.inputs.date_override }}"
          else
            TARGET_DATE=$(date -d "yesterday -1 day" +%Y-%m-%d)
          fi
          echo "target_date=$TARGET_DATE" >> $GITHUB_OUTPUT
          
      - name: Check target directory
        run: |
          TARGET_DATE="${{ steps.date_calc.outputs.target_date }}"
          if [ -d "non_us_ips/$TARGET_DATE" ]; then
            echo "✅ 目标目录存在"
          else
            echo "❌ 目标目录不存在"
            find non_us_ips -maxdepth 1 -type d -name "202*" | sort
            exit 1
          fi
          
      - name: Merge files
        run: |
          python .github/scripts/merge_non_us_ips.py "${{ steps.date_calc.outputs.target_date }}"
          
      - name: Cleanup old files
        run: |
          python .github/scripts/cleanup_old_files.py
          
      - name: Show generated files
        run: |
          echo "=== 生成的文件 ==="
          find non_us_ips/merged -name "*.txt" -mmin -5 | head -10 || echo "没有新生成的文件"
          echo "=== 清理的文件 ==="
          echo "清理操作已完成"
