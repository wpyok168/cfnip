name: ğŸŒ Collect IP Addresses and Save to Files

on:
  schedule:
    - cron: '30 * * * *'   # Run at minute 30 of every hour (UTC)
  workflow_dispatch:        # Allow manual triggering
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual execution'

env:
  PYTHON_VERSION: '3.x'
  RETAIN_DAYS: 0
  KEEP_MINIMUM_RUNS: 5

permissions:
  contents: write
  actions: write

jobs:
  collect-ip-addresses:
    name: ğŸš€ Collect IP Addresses
    runs-on: ubuntu-latest
    outputs:
      timestamp: ${{ steps.timestamp.outputs.time }}
      files_changed: ${{ steps.changes-check.outputs.has_changes }}
    
    steps:
      # ========== INITIALIZATION ==========
      - name: â° Start Workflow
        run: |
          echo "ğŸ¯ Workflow triggered by: ${{ github.event_name }}"
          echo "ğŸ“… Current time: $(date)"
          echo "ğŸ” Repository: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref }}"
      - name: ğŸ“ Generate Timestamp
        id: timestamp
        run: echo "time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      # ========== CLEANUP ==========
      - name: ğŸ§¹ Cleanup Old Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: ${{ env.RETAIN_DAYS }}
          keep_minimum_runs: ${{ env.KEEP_MINIMUM_RUNS }}
          repository: ${{ github.repository }}

      # ========== REPOSITORY SETUP ==========
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      # ========== PYTHON ENVIRONMENT ==========
      - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          # ç§»é™¤äº† cache é…ç½®

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ”§ Installing Python dependencies..."
          pip install --upgrade pip
          pip install requests ipaddress
          echo "âœ… Dependencies installed successfully"
      # ========== IP COLLECTION ==========
      - name: ğŸŒ Collect IP Addresses
        id: ip-collection
        run: |
          echo "ğŸ•¸ï¸ Starting IP address collection..."
          start_time=$(date +%s)
          
          if python autoip6.py; then
            end_time=$(date +%s)
            duration=$((end_time - start_time))
            echo "âœ… IP collection completed successfully"
            echo "â±ï¸ Execution time: ${duration} seconds"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ IP collection failed"
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
      # ========== FILE VERIFICATION ==========
      - name: ğŸ” Verify Generated Files
        id: file-check
        run: |
          echo "ğŸ“‹ Checking generated files..."
          
          if [ -f "ip.txt" ] && [ -s "ip.txt" ]; then
            ip_count=$(wc -l < ip.txt | tr -d ' ')
            echo "âœ… ip.txt: $ip_count IP addresses"
            echo "ip_count=$ip_count" >> $GITHUB_OUTPUT
          else
            echo "âŒ ip.txt is missing or empty"
            exit 1
          fi
          
          if [ -f "ipv6.txt" ] && [ -s "ipv6.txt" ]; then
            ipv6_count=$(wc -l < ipv6.txt | tr -d ' ')
            echo "âœ… ipv6.txt: $ipv6_count IPv6 addresses"
            echo "ipv6_count=$ipv6_count" >> $GITHUB_OUTPUT
          else
            echo "âŒ ipv6.txt is missing or empty"
            exit 1
          fi
      # ========== CHANGES CHECK ==========
      - name: ğŸ“Š Check for Changes
        id: changes-check
        run: |
          echo "ğŸ“Š Checking for file changes..."
          if git diff --quiet HEAD -- ip.txt ipv6.txt; then
            echo "ğŸ“­ No changes detected in IP files"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¬ Changes detected in IP files"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Changed files:"
            git diff --name-only HEAD -- ip.txt ipv6.txt
          fi
      # ========== COMMIT CHANGES ==========
      - name: ğŸ’¾ Commit and Push Changes
        id: auto-commit
        if: steps.changes-check.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            chore: update IP addresses [auto]
            
            â€¢ Updated ip.txt: ${{ steps.file-check.outputs.ip_count }} IPv4 addresses
            â€¢ Updated ipv6.txt: ${{ steps.file-check.outputs.ipv6_count }} IPv6 addresses
            â€¢ Timestamp: ${{ steps.timestamp.outputs.time }}
            â€¢ Trigger: ${{ github.event_name }}
          commit_user_name: 'ğŸ¤– GitHub Actions Bot'
          commit_user_email: 'actions@users.noreply.github.com'
          commit_options: '--signoff'
          file_pattern: 'ip.txt ipv6.txt'
          skip_fetch: true
          skip_checkout: true

      # ========== WORKFLOW SUMMARY ==========
      - name: ğŸ“ˆ Workflow Summary
        if: always()
        run: |
          echo "## ğŸ¯ IP Collection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution time:** ${{ steps.timestamp.outputs.time }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“ File Status" >> $GITHUB_STEP_SUMMARY
          echo "- **IPv4 addresses:** ${{ steps.file-check.outputs.ip_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **IPv6 addresses:** ${{ steps.file-check.outputs.ipv6_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if steps.changes-check.outputs.has_changes == 'true'; then
            echo "### âœ… Changes Committed" >> $GITHUB_STEP_SUMMARY
            echo "IP address files have been updated and committed automatically." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ğŸ“­ No Changes" >> $GITHUB_STEP_SUMMARY
            echo "IP address files are already up to date." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Automatically generated by GitHub Actions*" >> $GITHUB_STEP_SUMMARY
      # ========== NOTIFICATION ==========
      - name: ğŸ‰ Success Notification
        if: success() && steps.changes-check.outputs.has_changes == 'true'
        run: |
          echo "ğŸ‰ Successfully updated IP addresses!"
          echo "ğŸ“Š IPv4: ${{ steps.file-check.outputs.ip_count }} addresses"
          echo "ğŸ“Š IPv6: ${{ steps.file-check.outputs.ipv6_count }} addresses"
      - name: â„¹ï¸ No Changes Notification
        if: success() && steps.changes-check.outputs.has_changes == 'false'
        run: |
          echo "â„¹ï¸ IP addresses are already up to date."
          echo "ğŸ“Š Current IPv4: ${{ steps.file-check.outputs.ip_count }} addresses"
          echo "ğŸ“Š Current IPv6: ${{ steps.file-check.outputs.ipv6_count }} addresses"
