name: ğŸŒ Collect IP Addresses with Regional Filtering

on:
  schedule:
    - cron: '30 * * * *'   # Run at minute 30 of every hour (UTC)
  workflow_dispatch:        # Allow manual triggering
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual execution'

env:
  PYTHON_VERSION: '3.x'
  RETAIN_DAYS: 0
  KEEP_MINIMUM_RUNS: 5
  OUTPUT_DIR: 'non-us-ips'

permissions:
  contents: write
  actions: write

jobs:
  collect-ip-addresses:
    name: ğŸš€ Collect IP Addresses
    runs-on: ubuntu-latest
    outputs:
      timestamp: ${{ steps.timestamp.outputs.time }}
      files_changed: ${{ steps.changes-check.outputs.has_changes }}
      output_files: ${{ steps.file-check.outputs.output_files }}
    
    steps:
      # ========== INITIALIZATION ==========
      - name: â° Start Workflow
        run: |
          echo "ğŸ¯ Workflow triggered by: ${{ github.event_name }}"
          echo "ğŸ“… Current time: $(date)"
          echo "ğŸ” Repository: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref }}"
          echo "ğŸ“ Output directory: ${{ env.OUTPUT_DIR }}"

      - name: ğŸ“ Generate Timestamp
        id: timestamp
        run: |
          current_time=$(date -u +'%Y-%m-%d_%H-%M-%S_UTC')
          echo "time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "filename_time=$current_time" >> $GITHUB_OUTPUT

      # ========== CLEANUP ==========
      - name: ğŸ§¹ Cleanup Old Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: ${{ env.RETAIN_DAYS }}
          keep_minimum_runs: ${{ env.KEEP_MINIMUM_RUNS }}
          repository: ${{ github.repository }}

      # ========== REPOSITORY SETUP ==========
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      # ========== CREATE OUTPUT DIRECTORY ==========
      - name: ğŸ“ Create Output Directory
        run: |
          echo "ğŸ“‚ Creating output directory: ${{ env.OUTPUT_DIR }}"
          mkdir -p ${{ env.OUTPUT_DIR }}
          echo "âœ… Directory created successfully"

      # ========== PYTHON ENVIRONMENT ==========
      - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ”§ Installing Python dependencies..."
          pip install --upgrade pip
          pip install requests ipaddress pycountry
          echo "âœ… Dependencies installed successfully"

      # ========== IP COLLECTION WITH REGIONAL FILTER ==========
      - name: ğŸŒ Collect Non-US IP Addresses
        id: ip-collection
        run: |
          echo "ğŸ•¸ï¸ Starting non-US IP address collection..."
          start_time=$(date +%s)
          
          # åˆ›å»ºå¢å¼ºç‰ˆçš„ IP æ”¶é›†è„šæœ¬
          cat > collect_non_us_ips.py << 'EOF'
import requests
import ipaddress
import pycountry
import json
from datetime import datetime
import os

def is_non_us_ip(ip):
    """æ£€æŸ¥ IP æ˜¯å¦ä¸å±äºç¾å›½"""
    try:
        # è¿™é‡Œä½¿ç”¨ ip-api.com è¿›è¡Œåœ°ç†å®šä½æŸ¥è¯¢
        response = requests.get(f'http://ip-api.com/json/{ip}?fields=countryCode', timeout=5)
        if response.status_code == 200:
            data = response.json()
            return data.get('countryCode') != 'US'
    except:
        pass
    return False

def collect_ips():
    """æ”¶é›† IP åœ°å€çš„ä¸»å‡½æ•°"""
    timestamp = datetime.utcnow().strftime('%Y-%m-%d_%H-%M-%S_UTC')
    output_dir = 'non-us-ips'
    
    # éç¾å›½ IPv4 åœ°å€
    ipv4_list = []
    # éç¾å›½ IPv6 åœ°å€  
    ipv6_list = []
    
    # è¿™é‡Œæ›¿æ¢ä¸ºä½ å®é™…çš„ IP æ”¶é›†é€»è¾‘
    # ç¤ºä¾‹ï¼šä»å¤šä¸ªæ¥æºæ”¶é›† IP
    sources = [
        'https://cdn.jsdelivr.net/gh/lukesampson/cidr-tools@master/data/cidr.txt',
        # æ·»åŠ æ›´å¤š IP æ¥æº
    ]
    
    for source in sources:
        try:
            response = requests.get(source, timeout=10)
            if response.status_code == 200:
                for line in response.text.splitlines():
                    line = line.strip()
                    if line and not line.startswith('#'):
                        try:
                            network = ipaddress.ip_network(line, strict=False)
                            # æŠ½æ ·æ£€æŸ¥éƒ¨åˆ† IP çš„åœ°ç†ä½ç½®
                            sample_ip = str(list(network.hosts())[0]) if network.num_addresses > 1 else str(network.network_address)
                            if is_non_us_ip(sample_ip):
                                if network.version == 4:
                                    ipv4_list.append(line)
                                else:
                                    ipv6_list.append(line)
                        except:
                            continue
        except Exception as e:
            print(f"Error processing {source}: {e}")
    
    # ä¿å­˜åˆ°æ–‡ä»¶
    os.makedirs(output_dir, exist_ok=True)
    
    # ä¸»æ–‡ä»¶ï¼ˆå§‹ç»ˆæ›´æ–°ï¼‰
    with open('ip.txt', 'w') as f:
        f.write('\n'.join(ipv4_list))
    
    with open('ipv6.txt', 'w') as f:
        f.write('\n'.join(ipv6_list))
    
    # æŒ‰æ—¶é—´æˆ³ä¿å­˜çš„æ–‡ä»¶
    ipv4_filename = f'{output_dir}/ipv4_non_us_{timestamp}.txt'
    ipv6_filename = f'{output_dir}/ipv6_non_us_{timestamp}.txt'
    
    with open(ipv4_filename, 'w') as f:
        f.write(f'# Non-US IPv4 addresses collected at {timestamp}\n')
        f.write(f'# Total: {len(ipv4_list)} addresses\n')
        f.write('\n'.join(ipv4_list))
    
    with open(ipv6_filename, 'w') as f:
        f.write(f'# Non-US IPv6 addresses collected at {timestamp}\n')
        f.write(f'# Total: {len(ipv6_list)} addresses\n')
        f.write('\n'.join(ipv6_list))
    
    # ä¿å­˜å…ƒæ•°æ®
    metadata = {
        'timestamp': timestamp,
        'ipv4_count': len(ipv4_list),
        'ipv6_count': len(ipv6_list),
        'sources': sources
    }
    
    with open(f'{output_dir}/metadata_{timestamp}.json', 'w') as f:
        json.dump(metadata, f, indent=2)
    
    print(f"âœ… Collected {len(ipv4_list)} non-US IPv4 addresses")
    print(f"âœ… Collected {len(ipv6_list)} non-US IPv6 addresses")
    print(f"ğŸ“ Files saved in: {output_dir}/")

if __name__ == '__main__':
    collect_ips()
EOF

          if python collect_non_us_ips.py; then
            end_time=$(date +%s)
            duration=$((end_time - start_time))
            echo "âœ… Non-US IP collection completed successfully"
            echo "â±ï¸ Execution time: ${duration} seconds"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ IP collection failed"
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      # ========== FILE VERIFICATION ==========
      - name: ğŸ” Verify Generated Files
        id: file-check
        run: |
          echo "ğŸ“‹ Checking generated files..."
          
          # æ£€æŸ¥ä¸»æ–‡ä»¶
          if [ -f "ip.txt" ] && [ -s "ip.txt" ]; then
            ip_count=$(wc -l < ip.txt | tr -d ' ')
            echo "âœ… ip.txt: $ip_count IPv4 addresses"
            echo "ip_count=$ip_count" >> $GITHUB_OUTPUT
          else
            echo "âŒ ip.txt is missing or empty"
            exit 1
          fi
          
          if [ -f "ipv6.txt" ] && [ -s "ipv6.txt" ]; then
            ipv6_count=$(wc -l < ipv6.txt | tr -d ' ')
            echo "âœ… ipv6.txt: $ipv6_count IPv6 addresses"
            echo "ipv6_count=$ipv6_count" >> $GITHUB_OUTPUT
          else
            echo "âŒ ipv6.txt is missing or empty"
            exit 1
          fi
          
          # æ£€æŸ¥æ—¶é—´æˆ³æ–‡ä»¶
          timestamp="${{ steps.timestamp.outputs.filename_time }}"
          output_dir="${{ env.OUTPUT_DIR }}"
          
          ipv4_file="${output_dir}/ipv4_non_us_${timestamp}.txt"
          ipv6_file="${output_dir}/ipv6_non_us_${timestamp}.txt"
          metadata_file="${output_dir}/metadata_${timestamp}.json"
          
          if [ -f "$ipv4_file" ] && [ -f "$ipv6_file" ]; then
            echo "âœ… Time-stamped files created:"
            echo "   - $ipv4_file"
            echo "   - $ipv6_file"
            echo "   - $metadata_file"
            echo "output_files=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Time-stamped files missing"
            echo "output_files=false" >> $GITHUB_OUTPUT
          fi

      # ========== LIST GENERATED FILES ==========
      - name: ğŸ“‚ List Generated Files
        run: |
          echo "ğŸ“ Generated files in ${{ env.OUTPUT_DIR }}:"
          ls -la ${{ env.OUTPUT_DIR }}/
          echo ""
          echo "ğŸ“Š File sizes:"
          find ${{ env.OUTPUT_DIR }} -name "*.txt" -exec wc -l {} \;

      # ========== CHANGES CHECK ==========
      - name: ğŸ“Š Check for Changes
        id: changes-check
        run: |
          echo "ğŸ“Š Checking for file changes..."
          if git diff --quiet HEAD -- ip.txt ipv6.txt ${{ env.OUTPUT_DIR }}; then
            echo "ğŸ“­ No changes detected in IP files"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¬ Changes detected in IP files"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Changed files:"
            git diff --name-only HEAD -- ip.txt ipv6.txt ${{ env.OUTPUT_DIR }}
          fi

      # ========== COMMIT CHANGES ==========
      - name: ğŸ’¾ Commit and Push Changes
        id: auto-commit
        if: steps.changes-check.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            chore: update non-US IP addresses [auto]
            
            â€¢ Updated ip.txt: ${{ steps.file-check.outputs.ip_count }} IPv4 addresses
            â€¢ Updated ipv6.txt: ${{ steps.file-check.outputs.ipv6_count }} IPv6 addresses
            â€¢ New time-stamped files in ${{ env.OUTPUT_DIR }}/
            â€¢ Timestamp: ${{ steps.timestamp.outputs.time }}
            â€¢ Trigger: ${{ github.event_name }}
          commit_user_name: 'ğŸ¤– GitHub Actions Bot'
          commit_user_email: 'actions@users.noreply.github.com'
          commit_options: '--signoff'
          file_pattern: 'ip.txt ipv6.txt ${{ env.OUTPUT_DIR }}/*'
          skip_fetch: true
          skip_checkout: true

      # ========== WORKFLOW SUMMARY ==========
      - name: ğŸ“ˆ Workflow Summary
        if: always()
        run: |
          echo "## ğŸ¯ Non-US IP Collection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution time:** ${{ steps.timestamp.outputs.time }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Output directory:** ${{ env.OUTPUT_DIR }}/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“ File Status" >> $GITHUB_STEP_SUMMARY
          echo "- **IPv4 addresses:** ${{ steps.file-check.outputs.ip_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **IPv6 addresses:** ${{ steps.file-check.outputs.ipv6_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time-stamped files:** ${{ steps.file-check.outputs.output_files }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“‚ Generated Files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -1 ${{ env.OUTPUT_DIR }}/ 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if steps.changes-check.outputs.has_changes == 'true'; then
            echo "### âœ… Changes Committed" >> $GITHUB_STEP_SUMMARY
            echo "IP address files have been updated and committed automatically." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ğŸ“­ No Changes" >> $GITHUB_STEP_SUMMARY
            echo "IP address files are already up to date." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Automatically generated by GitHub Actions*" >> $GITHUB_STEP_SUMMARY

      # ========== CLEANUP OLD FILES ==========
      - name: ğŸ—‘ï¸ Cleanup Old Files (Optional)
        if: success()
        run: |
          echo "ğŸ§¹ Cleaning up files older than 7 days..."
          find ${{ env.OUTPUT_DIR }} -name "*.txt" -mtime +7 -exec echo "Deleting: {}" \;
          # å®é™…åˆ é™¤å–æ¶ˆæ³¨é‡Šä¸‹ä¸€è¡Œ
          # find ${{ env.OUTPUT_DIR }} -name "*.txt" -mtime +7 -delete
