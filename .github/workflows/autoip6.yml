name: ğŸŒ æ”¶é›†Cloudflare IPåœ°å€

on:
  schedule:
    - cron: '30 * * * *'   # æ¯å°æ—¶çš„30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æ‰‹åŠ¨æ‰§è¡Œ'

env:
  PYTHON_VERSION: '3.10'
  RETAIN_DAYS: 0
  KEEP_MINIMUM_RUNS: 5

permissions:
  contents: write
  actions: write

jobs:
  collect-ip-addresses:
    name: ğŸš€ æ”¶é›†IPåœ°å€
    runs-on: ubuntu-latest
    outputs:
      timestamp: ${{ steps.timestamp.outputs.time }}
      files_changed: ${{ steps.changes-check.outputs.has_changes }}
      ipv4_count: ${{ steps.file-check.outputs.ip_count }}
      ipv6_count: ${{ steps.file-check.outputs.ipv6_count }}
    
    steps:
      # ========== åˆå§‹åŒ– ==========
      - name: â° å¼€å§‹å·¥ä½œæµ
        run: |
          echo "ğŸ¯ å·¥ä½œæµè§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "ğŸ“… å½“å‰æ—¶é—´: $(date)"
          echo "ğŸ” ä»“åº“: ${{ github.repository }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref }}"
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸ›ï¸ è§¦å‘åŸå› : ${{ github.event.inputs.reason }}"
          fi

      - name: ğŸ“ ç”Ÿæˆæ—¶é—´æˆ³
        id: timestamp
        run: echo "time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      # ========== æ¸…ç† ==========
      - name: ğŸ§¹ æ¸…ç†æ—§å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: ${{ env.RETAIN_DAYS }}
          keep_minimum_runs: ${{ env.KEEP_MINIMUM_RUNS }}
          repository: ${{ github.repository }}

      # ========== ä»“åº“è®¾ç½® ==========
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      # ========== Pythonç¯å¢ƒ ==========
      - name: ğŸ è®¾ç½®Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ”§ å®‰è£…Pythonä¾èµ–..."
          pip install --upgrade pip
          pip install requests ipaddress
          echo "âœ… ä¾èµ–å®‰è£…æˆåŠŸ"

      # ========== IPåœ°å€æ”¶é›† ==========
      - name: ğŸŒ æ”¶é›†IPåœ°å€
        id: ip-collection
        run: |
          echo "ğŸ•¸ï¸ å¼€å§‹æ”¶é›†IPåœ°å€..."
          start_time=$(date +%s)
          
          # ä½¿ç”¨æ–°çš„ä¼˜åŒ–è„šæœ¬
          if python cf_ip_collector.py; then
            end_time=$(date +%s)
            duration=$((end_time - start_time))
            echo "âœ… IPåœ°å€æ”¶é›†å®Œæˆ"
            echo "â±ï¸ æ‰§è¡Œæ—¶é—´: ${duration} ç§’"
            echo "result=success" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºæ–‡ä»¶å¤§å°ä¿¡æ¯
            echo "ğŸ“ ç”Ÿæˆæ–‡ä»¶ä¿¡æ¯:"
            ls -la ip.txt ipv6.txt 2>/dev/null || echo "æ–‡ä»¶æœªç”Ÿæˆ"
          else
            echo "âŒ IPåœ°å€æ”¶é›†å¤±è´¥"
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      # ========== æ–‡ä»¶éªŒè¯ ==========
      - name: ğŸ” éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
        id: file-check
        run: |
          echo "ğŸ“‹ æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          
          # æ£€æŸ¥ä¸»è¦è¾“å‡ºæ–‡ä»¶
          if [ -f "ip.txt" ] && [ -s "ip.txt" ]; then
            ip_count=$(wc -l < ip.txt | tr -d ' ')
            file_size=$(stat -f%z ip.txt 2>/dev/null || stat -c%s ip.txt 2>/dev/null || echo "æœªçŸ¥")
            echo "âœ… ip.txt: $ip_count ä¸ªIPv4åœ°å€ (å¤§å°: ${file_size} bytes)"
            echo "ip_count=$ip_count" >> $GITHUB_OUTPUT
          else
            echo "âŒ ip.txt æ–‡ä»¶ç¼ºå¤±æˆ–ä¸ºç©º"
            exit 1
          fi
          
          if [ -f "ipv6.txt" ] && [ -s "ipv6.txt" ]; then
            ipv6_count=$(wc -l < ipv6.txt | tr -d ' ')
            file_size=$(stat -f%z ipv6.txt 2>/dev/null || stat -c%s ipv6.txt 2>/dev/null || echo "æœªçŸ¥")
            echo "âœ… ipv6.txt: $ipv6_count ä¸ªIPv6åœ°å€ (å¤§å°: ${file_size} bytes)"
            echo "ipv6_count=$ipv6_count" >> $GITHUB_OUTPUT
          else
            echo "âŒ ipv6.txt æ–‡ä»¶ç¼ºå¤±æˆ–ä¸ºç©º"
            exit 1
          fi
          
          # æ£€æŸ¥ç»“æœæ–‡ä»¶å¤¹
          if [ -d "cf_ip_results" ]; then
            result_files=$(find cf_ip_results -name "*.txt" | wc -l)
            echo "ğŸ“‚ ç»“æœæ–‡ä»¶å¤¹åŒ…å«: $result_files ä¸ªå†å²æ–‡ä»¶"
          fi

      # ========== å˜æ›´æ£€æŸ¥ ==========
      - name: ğŸ“Š æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: changes-check
        run: |
          echo "ğŸ“Š æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ£€æŸ¥æ–‡ä»¶å·®å¼‚
          if git diff --quiet HEAD -- ip.txt ipv6.txt 2>/dev/null; then
            echo "ğŸ“­ æœªæ£€æµ‹åˆ°IPæ–‡ä»¶å˜æ›´"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¬ æ£€æµ‹åˆ°IPæ–‡ä»¶å˜æ›´"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºå…·ä½“å˜æ›´
            echo "ğŸ“ å˜æ›´è¯¦æƒ…:"
            git diff --stat HEAD -- ip.txt ipv6.txt || echo "æ— æ³•æ˜¾ç¤ºå·®å¼‚è¯¦æƒ…"
          fi

      # ========== æäº¤å˜æ›´ ==========
      - name: ğŸ’¾ æäº¤å¹¶æ¨é€å˜æ›´
        id: auto-commit
        if: steps.changes-check.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            chore: è‡ªåŠ¨æ›´æ–°Cloudflare IPåœ°å€
            
            â€¢ æ›´æ–° IPv4: ${{ steps.file-check.outputs.ip_count }} ä¸ªåœ°å€
            â€¢ æ›´æ–° IPv6: ${{ steps.file-check.outputs.ipv6_count }} ä¸ªåœ°å€
            â€¢ æ—¶é—´æˆ³: ${{ steps.timestamp.outputs.time }}
            â€¢ è§¦å‘æ–¹å¼: ${{ github.event.name }}
            ${{ github.event.inputs.reason && format('â€¢ æ‰‹åŠ¨è§¦å‘åŸå› : {0}', github.event.inputs.reason) || '' }}
          commit_user_name: 'ğŸ¤– GitHub Actions Bot'
          commit_user_email: 'actions@users.noreply.github.com'
          commit_options: '--signoff'
          file_pattern: |
            ip.txt
            ipv6.txt
            cf_ip_results/
          skip_fetch: true
          skip_checkout: true
          status_options: '--untracked-files=no'

      # ========== å·¥ä½œæµæ€»ç»“ ==========
      - name: ğŸ“ˆ å·¥ä½œæµæ€»ç»“
        if: always()
        run: |
          echo "## ğŸ¯ Cloudflare IPåœ°å€æ”¶é›†æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“Š æ‰§è¡Œè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´:** ${{ steps.timestamp.outputs.time }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "- **è§¦å‘åŸå› :** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **ä»“åº“:** \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“ æ”¶é›†ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "- **IPv4åœ°å€æ•°é‡:** \`${{ steps.file-check.outputs.ip_count }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **IPv6åœ°å€æ•°é‡:** \`${{ steps.file-check.outputs.ipv6_count }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if steps.changes-check.outputs.has_changes == 'true'; then
            echo "### âœ… å˜æ›´å·²æäº¤" >> $GITHUB_STEP_SUMMARY
            echo "IPåœ°å€æ–‡ä»¶å·²æ›´æ–°å¹¶è‡ªåŠ¨æäº¤åˆ°ä»“åº“ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### ğŸ“‹ æ–‡ä»¶çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
            echo "| æ–‡ä»¶ | è¡Œæ•° | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| \`ip.txt\` | ${{ steps.file-check.outputs.ip_count }} | âœ… å·²æ›´æ–° |" >> $GITHUB_STEP_SUMMARY
            echo "| \`ipv6.txt\` | ${{ steps.file-check.outputs.ipv6_count }} | âœ… å·²æ›´æ–° |" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ğŸ“­ æ— å˜æ›´" >> $GITHUB_STEP_SUMMARY
            echo "IPåœ°å€æ–‡ä»¶å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ â€¢ æœ€åæ›´æ–°: $(date -u +'%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY

      # ========== é€šçŸ¥ ==========
      - name: ğŸ‰ æˆåŠŸé€šçŸ¥
        if: success() && steps.changes-check.outputs.has_changes == 'true'
        run: |
          echo "ğŸ‰ æˆåŠŸæ›´æ–°Cloudflare IPåœ°å€ï¼"
          echo "ğŸ“Š IPv4: ${{ steps.file-check.outputs.ip_count }} ä¸ªåœ°å€"
          echo "ğŸ“Š IPv6: ${{ steps.file-check.outputs.ipv6_count }} ä¸ªåœ°å€"
          echo "ğŸ•’ æ—¶é—´: ${{ steps.timestamp.outputs.time }}"

      - name: â„¹ï¸ æ— å˜æ›´é€šçŸ¥
        if: success() && steps.changes-check.outputs.has_changes == 'false'
        run: |
          echo "â„¹ï¸ IPåœ°å€å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°ã€‚"
          echo "ğŸ“Š å½“å‰IPv4: ${{ steps.file-check.outputs.ip_count }} ä¸ªåœ°å€"
          echo "ğŸ“Š å½“å‰IPv6: ${{ steps.file-check.outputs.ipv6_count }} ä¸ªåœ°å€"

      - name: âš ï¸ å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ IPåœ°å€æ”¶é›†è¿‡ç¨‹å‡ºç°é”™è¯¯ï¼"
          echo "ğŸ”§ è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯ã€‚"
          exit 1
