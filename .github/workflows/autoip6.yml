name: ğŸŒ æ”¶é›†Cloudflare IPåœ°å€

on:
  schedule:
    # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 */6 * * *'
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æ‰‹åŠ¨æ›´æ–°IPåœ°å€'
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  PYTHON_VERSION: '3.10'

permissions:
  contents: write
  actions: read

jobs:
  collect-ips:
    name: ğŸš€ æ”¶é›†IPåœ°å€
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # ========== åˆå§‹åŒ– ==========
      - name: â° å¼€å§‹å·¥ä½œæµ
        run: |
          echo "ğŸ¯ å·¥ä½œæµè§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "ğŸ“… å¼€å§‹æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ” ä»“åº“: ${{ github.repository }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref }}"
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸ›ï¸  æ‰‹åŠ¨è§¦å‘åŸå› : ${{ github.event.inputs.reason }}"
          fi

      - name: ğŸ“ ç”Ÿæˆæ—¶é—´æˆ³
        id: timestamp
        run: |
          echo "time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "date=$(date -u +'%Y%m%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(date -u +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT

      # ========== æ£€å‡ºä»£ç  ==========
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ========== Pythonç¯å¢ƒè®¾ç½® ==========
      - name: ğŸ è®¾ç½®Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ”§ å®‰è£…Pythonä¾èµ–..."
          python -m pip install --upgrade pip
          pip install requests ipaddress
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          pip list

      # ========== æ‰§è¡ŒIPæ”¶é›†è„šæœ¬ ==========
      - name: ğŸŒ è¿è¡ŒIPæ”¶é›†è„šæœ¬
        id: collect-ips
        run: |
          echo "ğŸ•¸ï¸ å¼€å§‹æ”¶é›†Cloudflare IPåœ°å€..."
          start_time=$(date +%s)
          
          # è¿è¡ŒPythonè„šæœ¬
          python autoip6.py
          
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "â±ï¸ è„šæœ¬æ‰§è¡Œæ—¶é—´: ${duration} ç§’"
          
          # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
          echo "ğŸ“‹ æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          ls -la *.txt

      # ========== æ–‡ä»¶éªŒè¯ ==========
      - name: ğŸ” éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
        id: verify-files
        run: |
          echo "ğŸ“Š æ–‡ä»¶éªŒè¯æŠ¥å‘Š:"
          echo "========================"
          
          declare -A file_info=(
            ["ip.txt"]="IPv4åœ°å€"
            ["ipv6.txt"]="IPv6åœ°å€" 
            ["non_us_ip.txt"]="éç¾å›½IPv4åœ°å€"
            ["non_us_ipv6.txt"]="éç¾å›½IPv6åœ°å€"
          )
          
          all_files_valid=true
          
          for file in "${!file_info[@]}"; do
            if [ -f "$file" ] && [ -s "$file" ]; then
              line_count=$(grep -c -v '^#' "$file" | tr -d ' ' || wc -l < "$file" | tr -d ' ')
              size=$(du -h "$file" | cut -f1)
              echo "âœ… $file: ${file_info[$file]} | è¡Œæ•°: $line_count | å¤§å°: $size"
              echo "${file}_count=$line_count" >> $GITHUB_OUTPUT
            else
              echo "âŒ $file: ${file_info[$file]} | æ–‡ä»¶ç¼ºå¤±æˆ–ä¸ºç©º"
              all_files_valid=false
              echo "${file}_count=0" >> $GITHUB_OUTPUT
            fi
          done
          
          if [ "$all_files_valid" = false ]; then
            echo "âŒ éƒ¨åˆ†æ–‡ä»¶éªŒè¯å¤±è´¥"
            exit 1
          else
            echo "âœ… æ‰€æœ‰æ–‡ä»¶éªŒè¯æˆåŠŸ"
          fi

      # ========== æ–‡ä»¶å˜æ›´æ£€æŸ¥ ==========
      - name: ğŸ“ˆ æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: check-changes
        run: |
          echo "ğŸ”„ æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ·»åŠ æ‰€æœ‰txtæ–‡ä»¶åˆ°æš‚å­˜åŒº
          git add *.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --cached --quiet; then
            echo "ğŸ“­ æœªæ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¬ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ å˜æ›´è¯¦æƒ…:"
            git diff --cached --name-only
          fi

      # ========== æäº¤å˜æ›´ ==========
      - name: ğŸ’¾ æäº¤å¹¶æ¨é€å˜æ›´
        if: steps.check-changes.outputs.changes_detected == 'true'
        run: |
          echo "ğŸš€ æäº¤å˜æ›´åˆ°ä»“åº“..."
          commit_msg="chore: è‡ªåŠ¨æ›´æ–°Cloudflare IPåœ°å€åˆ—è¡¨
          
          â€¢ æ›´æ–° IPv4 åœ°å€: ${{ steps.verify-files.outputs.ip_txt_count }} ä¸ª
          â€¢ æ›´æ–° IPv6 åœ°å€: ${{ steps.verify-files.outputs.ipv6_txt_count }} ä¸ª  
          â€¢ éç¾å›½ IPv4: ${{ steps.verify-files.outputs.non_us_ip_txt_count }} ä¸ª
          â€¢ éç¾å›½ IPv6: ${{ steps.verify-files.outputs.non_us_ipv6_txt_count }} ä¸ª
          â€¢ æ›´æ–°æ—¶é—´: ${{ steps.timestamp.outputs.time }}
          â€¢ è§¦å‘æ–¹å¼: ${{ github.event.name }}
          
          æ­¤æäº¤ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ"
          
          git commit -m "$commit_msg" --signoff
          git push
          echo "âœ… å˜æ›´å·²æäº¤å¹¶æ¨é€åˆ°ä»“åº“"

      # ========== å·¥ä½œæµæ€»ç»“ ==========
      - name: ğŸ“Š ç”Ÿæˆå·¥ä½œæµæ€»ç»“
        if: always()
        run: |
          echo "## ğŸŒ Cloudflare IPåœ°å€æ”¶é›†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“‹ æ‰§è¡Œä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´:** ${{ steps.timestamp.outputs.time }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡ŒçŠ¶æ€:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "- **è§¦å‘åŸå› :** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“ æ–‡ä»¶ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "| æ–‡ä»¶ç±»å‹ | æ•°é‡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| IPv4 åœ°å€ | ${{ steps.verify-files.outputs.ip_txt_count }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| IPv6 åœ°å€ | ${{ steps.verify-files.outputs.ipv6_txt_count }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| éç¾å›½ IPv4 | ${{ steps.verify-files.outputs.non_us_ip_txt_count }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| éç¾å›½ IPv6 | ${{ steps.verify-files.outputs.non_us_ipv6_txt_count }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if steps.check-changes.outputs.changes_detected == 'true'; then
            echo "### âœ… å˜æ›´å·²æäº¤" >> $GITHUB_STEP_SUMMARY
            echo "IPåœ°å€åˆ—è¡¨å·²æ›´æ–°å¹¶è‡ªåŠ¨æäº¤åˆ°ä»“åº“ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ğŸ“­ æ— å˜æ›´" >> $GITHUB_STEP_SUMMARY
            echo "IPåœ°å€åˆ—è¡¨å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ”„ ä¸‹æ¬¡æ‰§è¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "æ­¤å·¥ä½œæµè®¡åˆ’æ¯6å°æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡ï¼Œä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*æœ€åæ›´æ–°: ${{ steps.timestamp.outputs.time }}*" >> $GITHUB_STEP_SUMMARY

      # ========== é€šçŸ¥ ==========
      - name: ğŸ‰ æˆåŠŸé€šçŸ¥
        if: success() && steps.check-changes.outputs.changes_detected == 'true'
        run: |
          echo "ğŸ‰ IPåœ°å€æ›´æ–°æˆåŠŸ!"
          echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
          echo "  - IPv4åœ°å€: ${{ steps.verify-files.outputs.ip_txt_count }} ä¸ª"
          echo "  - IPv6åœ°å€: ${{ steps.verify-files.outputs.ipv6_txt_count }} ä¸ª"
          echo "  - éç¾å›½IPv4: ${{ steps.verify-files.outputs.non_us_ip_txt_count }} ä¸ª"
          echo "  - éç¾å›½IPv6: ${{ steps.verify-files.outputs.non_us_ipv6_txt_count }} ä¸ª"
          echo "âœ… å˜æ›´å·²è‡ªåŠ¨æäº¤åˆ°ä»“åº“"

      - name: â„¹ï¸ æ— å˜æ›´é€šçŸ¥
        if: success() && steps.check-changes.outputs.changes_detected == 'false'
        run: |
          echo "â„¹ï¸ IPåœ°å€åˆ—è¡¨å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
          echo "ğŸ“Š å½“å‰ç»Ÿè®¡:"
          echo "  - IPv4åœ°å€: ${{ steps.verify-files.outputs.ip_txt_count }} ä¸ª"
          echo "  - IPv6åœ°å€: ${{ steps.verify-files.outputs.ipv6_txt_count }} ä¸ª"
          echo "  - éç¾å›½IPv4: ${{ steps.verify-files.outputs.non_us_ip_txt_count }} ä¸ª"
          echo "  - éç¾å›½IPv6: ${{ steps.verify-files.outputs.non_us_ipv6_txt_count }} ä¸ª"

      - name: âš ï¸ å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ IPåœ°å€æ”¶é›†å¤±è´¥!"
          echo "è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„åŸå› :"
          echo "  - ç½‘ç»œè¿æ¥é—®é¢˜"
          echo "  - æ•°æ®æºä¸å¯ç”¨"
          echo "  - è„šæœ¬æ‰§è¡Œé”™è¯¯"
          echo "æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚"
