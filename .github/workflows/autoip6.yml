name: ðŸ“¡ Collect IP Addresses and Save to Files

on:
  schedule:
    - cron: '30 * * * *'   # Execute at minute 30 of every hour (UTC)
  workflow_dispatch:        # Allow manual triggering
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual execution'

env:
  MAX_RETRIES: 3
  TIMEOUT_SECONDS: 30
  FILES_TO_UPDATE: 'ip.txt ipv6.txt'

permissions:
  contents: write
  actions: write

jobs:
  collect-ip-addresses:
    name: ðŸŽ¯ Collect IP Addresses
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      # Step 1: Clean up old workflow runs
      - name: ðŸ—‘ï¸ Delete Previous Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 0
          keep_minimum_runs: 3
          repository: ${{ github.repository }}
          
      # Step 2: Checkout repository
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # Step 3: Set up Python environment
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      # Step 4: Install Python dependencies
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests ipaddress beautifulsoup4
        timeout-minutes: 2
        
      # Step 5: Create script directory if needed
      - name: ðŸ“ Ensure Script Directory
        run: |
          if [ ! -f "autoip6.py" ]; then
            echo "âš ï¸ Warning: autoip6.py not found, creating basic template"
            cat > autoip6.py << 'EOF'
          # IP Collection Script Template
          import requests
          import json
          
          def main():
              print("ðŸ“¡ Starting IP collection...")
              # Add your IP collection logic here
              print("âœ… IP collection completed")
              
          if __name__ == "__main__":
              main()
          EOF
          fi
          
      # Step 6: Execute IP collection script
      - name: ðŸš€ Run IP Collection Script
        run: |
          echo "ðŸ• Starting IP collection at $(date)"
          python autoip6.py
          echo "âœ… IP collection finished at $(date)"
        timeout-minutes: 5
        
      # Step 7: Verify generated files
      - name: ðŸ” Verify Generated Files
        run: |
          echo "ðŸ“‹ Checking generated files:"
          for file in $FILES_TO_UPDATE; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists ($(wc -l < "$file") lines)"
              head -3 "$file" | while read line; do echo "   ðŸ“ $line"; done
            else
              echo "âŒ $file not found"
            fi
          done
          
      # Step 8: Commit and push changes
      - name: ðŸ’¾ Commit and Push Results
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            chore: update IP address files [auto]
            
            - Automated IP collection
            - Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            - Workflow: ${{ github.workflow }}
            - Run: ${{ github.run_id }}
          commit_user_name: 'ðŸ¤– GitHub Actions Bot'
          commit_user_email: 'actions@users.noreply.github.com'
          file_pattern: ${{ env.FILES_TO_UPDATE }}
          commit_options: '--signoff'
          push_options: '--force'
          skip_fetch: true
          
      # Step 9: Success notification
      - name: âœ… Success Notification
        if: success()
        run: |
          echo "ðŸŽ‰ IP collection completed successfully!"
          echo "ðŸ“Š Files updated: $FILES_TO_UPDATE"
          echo "ðŸ”— Workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
      # Step 10: Failure notification
      - name: âŒ Failure Notification
        if: failure()
        run: |
          echo "ðŸ’¥ IP collection failed!"
          echo "ðŸ“ Check the logs for details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          exit 1
