name: ğŸŒ æ”¶é›†IPåœ°å€å¹¶ä¿å­˜åˆ°æ–‡ä»¶

on:
  schedule:
    - cron: '30 * * * *'   # ä¸»è¦è°ƒåº¦ï¼šæ¯å°æ—¶çš„30åˆ†é’Ÿè¿è¡Œ
    - cron: '0 * * * *'    # å¤‡ç”¨è°ƒåº¦ï¼šæ¯å°æ—¶çš„0åˆ†é’Ÿè¿è¡Œï¼ˆæ•´ç‚¹ï¼‰
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æ‰‹åŠ¨æ‰§è¡Œ'
  push:                    # ä»£ç æ¨é€æ—¶è§¦å‘ï¼ˆå¤‡ç”¨ï¼‰
    branches: [ main, master ]
    paths:
      - '.github/workflows/**'
      - 'autoip6.py'
      - 'scripts/**'
  pull_request:            # PRæ—¶è§¦å‘ï¼ˆæµ‹è¯•ç”¨ï¼‰
    branches: [ main, master ]
    paths:
      - '.github/workflows/**'
      - 'autoip6.py'

env:
  PYTHON_VERSION: '3.x'
  RETAIN_DAYS: 0
  KEEP_MINIMUM_RUNS: 5

permissions:
  contents: write
  actions: write

jobs:
  collect-ip-addresses:
    name: ğŸš€ æ”¶é›†IPåœ°å€
    runs-on: ubuntu-latest
    outputs:
      timestamp: ${{ steps.timestamp.outputs.time }}
      files_changed: ${{ steps.changes-check.outputs.has_changes }}
      trigger_type: ${{ steps.debug.outputs.trigger_type }}
    
    steps:
      # ========== è°ƒè¯•ä¿¡æ¯ ==========
      - name: ğŸ” è°ƒè¯•è§¦å‘ä¿¡æ¯
        id: debug
        run: |
          echo "ğŸ¯ å·¥ä½œæµè§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "ğŸ“… å½“å‰æ—¶é—´: $(date)"
          echo "ğŸ• UTCæ—¶é—´: $(date -u)"
          echo "ğŸ” ä»“åº“: ${{ github.repository }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref }}"
          echo "ğŸ‘¤ è§¦å‘è€…: ${{ github.actor }}"
          
          # è®¾ç½®è§¦å‘ç±»å‹è¾“å‡º
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "è§¦å‘ç±»å‹: å®šæ—¶è°ƒåº¦"
            echo "trigger_type=scheduled" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "è§¦å‘ç±»å‹: æ‰‹åŠ¨æ‰§è¡Œ"
            echo "åŸå› : ${{ github.event.inputs.reason }}"
            echo "trigger_type=manual" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "è§¦å‘ç±»å‹: ä»£ç æ¨é€"
            echo "trigger_type=push" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "è§¦å‘ç±»å‹: æ‹‰å–è¯·æ±‚"
            echo "trigger_type=pull_request" >> $GITHUB_OUTPUT
          else
            echo "è§¦å‘ç±»å‹: å…¶ä»– (${{ github.event_name }})"
            echo "trigger_type=other" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ ç”Ÿæˆæ—¶é—´æˆ³
        id: timestamp
        run: echo "time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      # ========== æ¸…ç† ==========
      - name: ğŸ§¹ æ¸…ç†æ—§å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: ${{ env.RETAIN_DAYS }}
          keep_minimum_runs: ${{ env.KEEP_MINIMUM_RUNS }}
          repository: ${{ github.repository }}

      # ========== ä»“åº“è®¾ç½® ==========
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}

      # ========== Pythonç¯å¢ƒ ==========
      - name: ğŸ è®¾ç½®Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ”§ å®‰è£…Pythonä¾èµ–..."
          pip install --upgrade pip
          pip install requests ipaddress
          echo "âœ… ä¾èµ–å®‰è£…æˆåŠŸ"

      # ========== IPåœ°å€æ”¶é›† ==========
      - name: ğŸŒ æ”¶é›†IPåœ°å€
        id: ip-collection
        run: |
          echo "ğŸ•¸ï¸ å¼€å§‹æ”¶é›†IPåœ°å€..."
          echo "ğŸ“‹ è§¦å‘ç±»å‹: ${{ steps.debug.outputs.trigger_type }}"
          start_time=$(date +%s)
          
          if python autoip6.py; then
            end_time=$(date +%s)
            duration=$((end_time - start_time))
            echo "âœ… IPåœ°å€æ”¶é›†å®Œæˆ"
            echo "â±ï¸ æ‰§è¡Œæ—¶é—´: ${duration} ç§’"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ IPåœ°å€æ”¶é›†å¤±è´¥"
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      # ========== æ–‡ä»¶éªŒè¯ ==========
      - name: ğŸ” éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
        id: file-check
        run: |
          echo "ğŸ“‹ æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          
          if [ -f "ip.txt" ] && [ -s "ip.txt" ]; then
            ip_count=$(wc -l < ip.txt | tr -d ' ')
            echo "âœ… ip.txt: $ip_count ä¸ªIPv4åœ°å€"
            echo "ip_count=$ip_count" >> $GITHUB_OUTPUT
          else
            echo "âŒ ip.txt æ–‡ä»¶ç¼ºå¤±æˆ–ä¸ºç©º"
            exit 1
          fi
          
          if [ -f "ipv6.txt" ] && [ -s "ipv6.txt" ]; then
            ipv6_count=$(wc -l < ipv6.txt | tr -d ' ')
            echo "âœ… ipv6.txt: $ipv6_count ä¸ªIPv6åœ°å€"
            echo "ipv6_count=$ipv6_count" >> $GITHUB_OUTPUT
          else
            echo "âŒ ipv6.txt æ–‡ä»¶ç¼ºå¤±æˆ–ä¸ºç©º"
            exit 1
          fi
          
          # æ£€æŸ¥éç¾å›½åŒºåŸŸIPæ–‡ä»¶
          echo "ğŸ” æ£€æŸ¥éç¾å›½åŒºåŸŸIPæ–‡ä»¶..."
          non_us_files=$(find non_us_ips -name "non_us_ips_*.txt" -type f 2>/dev/null | wc -l)
          if [ "$non_us_files" -gt 0 ]; then
            latest_non_us=$(find non_us_ips -name "non_us_ips_*.txt" -type f | sort -r | head -1)
            non_us_count=$(wc -l < "$latest_non_us" | tr -d ' ')
            echo "âœ… éç¾å›½åŒºåŸŸIPæ–‡ä»¶: $non_us_files ä¸ªæ–‡ä»¶ï¼Œæœ€æ–°æ–‡ä»¶åŒ…å« $non_us_count è¡Œ"
            echo "non_us_files=$non_us_files" >> $GITHUB_OUTPUT
            echo "non_us_count=$non_us_count" >> $GITHUB_OUTPUT
            echo "latest_non_us=$latest_non_us" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªæ‰¾åˆ°éç¾å›½åŒºåŸŸIPæ–‡ä»¶"
            echo "non_us_files=0" >> $GITHUB_OUTPUT
            echo "non_us_count=0" >> $GITHUB_OUTPUT
          fi

      # ========== å˜æ›´æ£€æŸ¥ ==========
      - name: ğŸ“Š æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: changes-check
        run: |
          echo "ğŸ“Š æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          # æ£€æŸ¥ä¸»è¦IPæ–‡ä»¶å’Œéç¾å›½åŒºåŸŸIPæ–‡ä»¶
          if git diff --quiet HEAD -- ip.txt ipv6.txt non_us_ips/; then
            echo "ğŸ“­ æœªæ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¬ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ å˜æ›´æ–‡ä»¶:"
            git diff --name-only HEAD -- ip.txt ipv6.txt non_us_ips/
          fi

      # ========== æäº¤å˜æ›´ ==========
      - name: ğŸ’¾ æäº¤å¹¶æ¨é€å˜æ›´
        id: auto-commit
        if: steps.changes-check.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            chore: æ›´æ–°IPåœ°å€ [è‡ªåŠ¨]
            
            â€¢ è§¦å‘ç±»å‹: ${{ steps.debug.outputs.trigger_type }}
            â€¢ æ›´æ–° ip.txt: ${{ steps.file-check.outputs.ip_count }} ä¸ªIPv4åœ°å€
            â€¢ æ›´æ–° ipv6.txt: ${{ steps.file-check.outputs.ipv6_count }} ä¸ªIPv6åœ°å€
            â€¢ æ—¶é—´æˆ³: ${{ steps.timestamp.outputs.time }}
            â€¢ å·¥ä½œæµ: ${{ github.workflow }}
          commit_user_name: 'ğŸ¤– GitHub Actions æœºå™¨äºº'
          commit_user_email: 'actions@users.noreply.github.com'
          commit_options: '--signoff'
          file_pattern: 'ip.txt ipv6.txt non_us_ips/*'
          skip_fetch: true
          skip_checkout: true

      # ========== å·¥ä½œæµæ€»ç»“ ==========
      - name: ğŸ“ˆ å·¥ä½œæµæ€»ç»“
        if: always()
        run: |
          echo "## ğŸ¯ IPåœ°å€æ”¶é›†æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š æ‰§è¡Œè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘ç±»å‹:** ${{ steps.debug.outputs.trigger_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´:** ${{ steps.timestamp.outputs.time }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“ æ–‡ä»¶çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- **IPv4åœ°å€æ•°é‡:** ${{ steps.file-check.outputs.ip_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **IPv6åœ°å€æ•°é‡:** ${{ steps.file-check.outputs.ipv6_count }}" >> $GITHUB_STEP_SUMMARY
          
          # æ·»åŠ éç¾å›½åŒºåŸŸIPä¿¡æ¯
          if [ "${{ steps.file-check.outputs.non_us_files }}" != "0" ]; then
            echo "- **éç¾å›½åŒºåŸŸIPæ–‡ä»¶:** ${{ steps.file-check.outputs.non_us_files }} ä¸ªæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "- **æœ€æ–°éç¾å›½IPæ–‡ä»¶:** ${{ steps.file-check.outputs.latest_non_us }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if steps.changes-check.outputs.has_changes == 'true'; then
            echo "### âœ… å˜æ›´å·²æäº¤" >> $GITHUB_STEP_SUMMARY
            echo "IPåœ°å€æ–‡ä»¶å·²æ›´æ–°å¹¶è‡ªåŠ¨æäº¤ã€‚" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.file-check.outputs.non_us_files }}" != "0" ]; then
              echo "ğŸ“ éç¾å›½åŒºåŸŸIPæ–‡ä»¶å·²ä¿å­˜åˆ°ä»“åº“" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ğŸ“­ æ— å˜æ›´" >> $GITHUB_STEP_SUMMARY
            echo "IPåœ°å€æ–‡ä»¶å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*" >> $GITHUB_STEP_SUMMARY

      # ========== é€šçŸ¥ ==========
      - name: ğŸ‰ æˆåŠŸé€šçŸ¥
        if: success() && steps.changes-check.outputs.has_changes == 'true'
        run: |
          echo "ğŸ‰ æˆåŠŸæ›´æ–°IPåœ°å€ï¼"
          echo "ğŸ“Š IPv4: ${{ steps.file-check.outputs.ip_count }} ä¸ªåœ°å€"
          echo "ğŸ“Š IPv6: ${{ steps.file-check.outputs.ipv6_count }} ä¸ªåœ°å€"
          echo "ğŸ”§ è§¦å‘ç±»å‹: ${{ steps.debug.outputs.trigger_type }}"
          if [ "${{ steps.file-check.outputs.non_us_files }}" != "0" ]; then
            echo "ğŸŒ éç¾å›½åŒºåŸŸIP: ${{ steps.file-check.outputs.non_us_files }} ä¸ªæ–‡ä»¶å·²ä¿å­˜"
          fi

      - name: â„¹ï¸ æ— å˜æ›´é€šçŸ¥
        if: success() && steps.changes-check.outputs.has_changes == 'false'
        run: |
          echo "â„¹ï¸ IPåœ°å€å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚"
          echo "ğŸ“Š å½“å‰IPv4: ${{ steps.file-check.outputs.ip_count }} ä¸ªåœ°å€"
          echo "ğŸ“Š å½“å‰IPv6: ${{ steps.file-check.outputs.ipv6_count }} ä¸ªåœ°å€"
          echo "ğŸ”§ è§¦å‘ç±»å‹: ${{ steps.debug.outputs.trigger_type }}"
          if [ "${{ steps.file-check.outputs.non_us_files }}" != "0" ]; then
            echo "ğŸ“ éç¾å›½åŒºåŸŸIPæ–‡ä»¶: ${{ steps.file-check.outputs.non_us_files }} ä¸ª"
          fi
